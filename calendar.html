<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metroplex Moving Calendar</title>
    
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* --- BASE STYLES --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 10px; 
            background-color: #f4f4f4;
        }

        #calendar-container {
            max-width: 1100px;
            margin: 0 auto;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        #calendar {
            min-height: 500px; 
            height: 80vh; 
        }

        #loading {
            text-align: center;
            font-size: 1.2em;
            color: #666;
            margin-bottom: 10px;
        }

        /* --- HEADER CUSTOMIZATION --- */
        .fc-header-toolbar {
            display: flex;
            flex-direction: column; 
            gap: 10px;
            margin-bottom: 1.5em !important;
        }

        .fc-toolbar-chunk {
            display: flex;
            justify-content: center; 
        }
        
        .fc-toolbar-title {
            font-size: 1.75em !important; 
            color: #333;
        }

        /* --- BUTTON STYLES (Blue #0C419a) --- */
        .fc-button-primary {
            background-color: #0C419a !important;
            border-color: #0C419a !important;
            padding: 8px 16px !important;
            font-weight: bold;
        }
        .fc-button-primary:hover {
            background-color: #082d6e !important;
            border-color: #082d6e !important;
        }
        .fc-button-active {
            background-color: #062252 !important;
            border-color: #062252 !important;
        }
        .fc-button-primary:disabled {
            background-color: #0C419a !important;
            border-color: #0C419a !important;
            opacity: 0.6;
        }

        /* --- POPUP STYLES --- */
        .popup-link {
            color: #3085d6;
            text-decoration: underline;
            font-weight: bold;
            cursor: pointer;
        }
        
        .services-box {
            background-color: #f9f9f9;
            border-left: 4px solid #0C419a;
            padding: 10px;
            margin-top: 5px;
            font-size: 0.9em;
            color: #444;
            white-space: pre-wrap; 
            text-align: left;
            min-height: 100px;     
            max-height: 350px;     
            overflow-y: auto;      
        }

        /* --- RESPONSIVE LOGIC --- */
        .fc-event-title {
            display: inline-block;
            margin-left: 4px;
        }

        @media (max-width: 600px) and (orientation: portrait) {
            .fc-event-title { display: none; }
            .fc-event-time {
                font-weight: bold;
                font-size: 1.1em;
                text-align: center;
                width: 100%;
                display: block;
            }
        }
    </style>
</head>
<body>

    <div id="calendar-container">
        <div id="loading">Loading calendar data...</div>
        <div id="calendar"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            const NETLIFY_ENDPOINT = "/.netlify/functions/get-calendar";
            const loadingMsg = document.getElementById('loading');
            const calendarEl = document.getElementById('calendar');

            // --- HELPER: Parse Zoho Date ---
            function parseZohoDate(dateStr) {
                if (!dateStr) return null;
                const parts = dateStr.split(' '); 
                if (parts.length < 3) return null;
                const dateParts = parts[0].split('-'); 
                const timeParts = parts[1].split(':'); 
                const meridian = parts[2];            
                let year = "20" + dateParts[2];
                let month = dateParts[0];
                let day = dateParts[1];
                let hour = parseInt(timeParts[0], 10);
                let minute = timeParts[1];
                if (meridian === "PM" && hour < 12) hour += 12;
                if (meridian === "AM" && hour === 12) hour = 0;
                return `${year}-${month}-${day}T${hour.toString().padStart(2, '0')}:${minute}:00`;
            }

            // --- HELPER: End Time ---
            function getEndTime(startDateIso, endTimeStr) {
                if (!startDateIso || !endTimeStr) return null;
                const dateOnly = startDateIso.split('T')[0];
                const parts = endTimeStr.split(' ');
                if (parts.length < 2) return null;
                const timeParts = parts[0].split(':');
                const meridian = parts[1];
                let hour = parseInt(timeParts[0], 10);
                let minute = timeParts[1];
                if (meridian === "PM" && hour < 12) hour += 12;
                if (meridian === "AM" && hour === 12) hour = 0;
                return `${dateOnly}T${hour.toString().padStart(2, '0')}:${minute}:00`;
            }

            // --- HELPER: Safely Get String ---
            function getZohoVal(field) {
                if (!field) return "";
                if (field.display_value) return field.display_value; 
                if (typeof field === 'string') return field;         
                return "";
            }

            // --- HELPER: Count Movers (For Colors) ---
            function countMovers(moversField) {
                if (!moversField) return 0;
                if (Array.isArray(moversField)) return moversField.length; 
                if (typeof moversField === 'string') {
                    if(moversField.trim() === "") return 0;
                    return moversField.split(',').length; 
                }
                return 0; 
            }

            // --- HELPER: Get Formatted String of Movers (For Popup) ---
            function getMoversString(moversField) {
                if (!moversField) return "None assigned";
                // 1. If it's an Array (common for Zoho lists)
                if (Array.isArray(moversField)) {
                    // Map through to get names, handling objects with .display_value if needed
                    var names = moversField.map(function(m) {
                        return (m.display_value) ? m.display_value : m;
                    });
                    return names.join(", ");
                }
                // 2. If it's a string, just return it
                return moversField;
            }

            // --- MAIN LOGIC ---
            fetch(NETLIFY_ENDPOINT)
                .then(res => res.json())
                .then(data => {
                    loadingMsg.style.display = 'none';

                    var calendarEvents = data.data.map(function(record) {
                        
                        var startISO = parseZohoDate(record.Agreed_Start_Date_Time);
                        var endISO = getEndTime(startISO, record.Estimate_End_Date_Time);
                        var safeName = getZohoVal(record.Customer_Name) || "Unknown";
                        var originRaw = getZohoVal(record.Origination_Address);
                        var destRaw = getZohoVal(record.Destination_Address); 
                        var servicesRaw = getZohoVal(record.Services_Provided);

                        // --- MOVERS LOGIC ---
                        var requiredCount = parseInt(record.Mover_Count) || 0; 
                        var actualMoversCount = countMovers(record.Movers2); 
                        var moversListString = getMoversString(record.Movers2); // Get names for popup

                        // --- COLOR LOGIC ---
                        var bgColor = '#0C419a'; // Blue
                        var bdColor = '#0C419a';
                        if (actualMoversCount < requiredCount) {
                            bgColor = '#fd7e14'; // Orange
                            bdColor = '#fd7e14';
                        }

                        return {
                            title: safeName, 
                            start: startISO,   
                            end: endISO,
                            backgroundColor: bgColor, 
                            borderColor: bdColor,
                            textColor: '#ffffff',
                            extendedProps: {
                                name: safeName, 
                                origin: originRaw,
                                destination: destRaw,
                                services: servicesRaw,
                                team: moversListString // Pass the names to the popup
                            }
                        };
                    });

                    var calendar = new FullCalendar.Calendar(calendarEl, {
                        initialView: 'dayGridMonth',
                        
                        headerToolbar: {
                            left: 'title',
                            center: '',
                            right: 'prev,next today' 
                        },

                        events: calendarEvents,
                        
                        // --- CLICK HANDLER ---
                        eventClick: function(info) {
                            info.jsEvent.preventDefault(); 
                            
                            var props = info.event.extendedProps;
                            var customer = props.name;
                            var teamList = props.team || "None assigned"; // Get team names

                            var originAddr = (props.origin || "").replace(/missing/gi, "").trim();
                            var destAddr = (props.destination || "").replace(/missing/gi, "").trim();
                            var servicesText = props.services ? String(props.services).trim() : "No service details available.";

                            var isApple = /Mac|iPhone|iPod|iPad/.test(navigator.userAgent);
                            var originLink, destLink;

                            if (isApple) {
                                originLink = "http://maps.apple.com/?daddr=" + encodeURIComponent(originAddr) + "&dirflg=d";
                                destLink = "http://maps.apple.com/?daddr=" + encodeURIComponent(destAddr) + "&dirflg=d";
                            } else {
                                originLink = "https://www.google.com/maps?daddr=" + encodeURIComponent(originAddr) + "&dirflg=t";
                                destLink = "https://www.google.com/maps?daddr=" + encodeURIComponent(destAddr) + "&dirflg=t";
                            }

                            Swal.fire({
                                title: customer,
                                width: 600,
                                html: `
                                    <div style="text-align: left; font-size: 1.1em;">
                                        
                                        <div style="margin-bottom: 15px;">
                                            <p style="margin: 0 0 15px 0;"> 
                                                <strong>üìç Pickup:</strong> 
                                                <a href="${originLink}" target="_blank" class="popup-link">${originAddr}</a>
                                            </p>
                                            <p style="margin: 0;">
                                                <strong>üèÅ Dropoff:</strong> 
                                                <a href="${destLink}" target="_blank" class="popup-link">${destAddr}</a>
                                            </p>
                                        </div>

                                        <hr style="border-top: 1px solid #eee; margin: 15px 0;">

                                        <strong>üìã Services Provided:</strong>
                                        <div class="services-box">${servicesText}</div>

                                        <hr style="border-top: 1px solid #eee; margin: 15px 0;">

                                        <strong>üë∑ Team:</strong>
                                        <div style="margin-top: 5px; color: #333; font-weight: 500;">
                                            ${teamList}
                                        </div>

                                    </div>
                                `,
                                showConfirmButton: true,
                                confirmButtonText: 'Close',
                                confirmButtonColor: '#0C419a'
                            });
                        }
                    });

                    calendar.render();
                })
                .catch(err => {
                    console.error("Error:", err);
                    loadingMsg.innerText = "Error loading data.";
                });
        });
    </script>
</body>
</html>
