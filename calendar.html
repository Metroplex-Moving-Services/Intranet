<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metroplex Moving Calendar</title>
    
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/@descope/web-js-sdk@1.12.1/dist/index.umd.js"></script>

    <style>
        /* --- COPY YOUR CSS HERE --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background-color: #ffffff; }
        #calendar-container { max-width: 100%; margin: 0; background: white; padding: 0; }
        #calendar { min-height: 600px; margin: 0 2px; }
        #loading { text-align: center; font-size: 1.2em; color: #666; margin-bottom: 10px; padding-top: 10px; }
        
        .fc-header-toolbar { display: flex; flex-direction: column; gap: 10px; padding-top: 10px; margin-bottom: 1.5em !important; }
        .fc-toolbar-title { font-size: 1.75em !important; color: #333; }
        
        .fc-button-primary { background-color: #0C419a !important; border-color: #0C419a !important; }
        .fc-button-primary:hover { background-color: #082d6e !important; border-color: #082d6e !important; }
        .fc-button-active { background-color: #062252 !important; border-color: #062252 !important; }
        .fc-button-primary:disabled { opacity: 0.6; }

        .fc-event-main { padding: 2px 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .selected-day { background-color: #fff9c4 !important; }
        .popup-link { color: #3085d6; text-decoration: underline; font-weight: bold; cursor: pointer; }
        .services-box { background-color: #f9f9f9; border-left: 4px solid #0C419a; padding: 10px; margin-top: 5px; font-size: 0.9em; color: #444; white-space: pre-wrap; text-align: left; min-height: 100px; max-height: 350px; overflow-y: auto; }
        
        @media (max-width: 900px) and (orientation: portrait) {
            .fc-event-title { display: none !important; } 
            .fc-event-time { font-weight: bold; font-size: 1.1em; text-align: center; width: 100%; display: block !important; }
        }
    </style>
</head>
<body>

    <div id="calendar-container">
        <div id="loading">Authenticating...</div>
        <div id="calendar"></div>
    </div>

    <script>
        // 1. Initialize Descope (Using your Project ID)
        const sdk = Descope({ projectId: 'P2qXQxJA4H4hvSu2AnDB5VjKnh1d', persistTokens: true });

        document.addEventListener('DOMContentLoaded', async function() {
            // 2. Get the Token from local storage (shared with index.html)
            const sessionToken = sdk.getSessionToken();

            if (!sessionToken || sdk.isJwtExpired(sessionToken)) {
                // Not logged in? Redirect parent window to login
                window.top.location.href = "/Intranet/login.html";
            } else {
                // Logged in? Start the Calendar
                initCalendar(sessionToken);
            }
        });

        function initCalendar(authToken) {
            const loadingMsg = document.getElementById('loading');
            loadingMsg.innerText = "Loading calendar data...";
            const calendarEl = document.getElementById('calendar');
            const NETLIFY_ENDPOINT = "/.netlify/functions/get-calendar";

            // --- ALL HELPER FUNCTIONS GO HERE ---
            function parseZohoDate(dateStr) {
                if (!dateStr) return null;
                const parts = dateStr.split(' '); 
                if (parts.length < 2) return null; 
                const dateParts = parts[0].split('-'); 
                const timeParts = parts[1].split(':'); 
                let year = dateParts[2];
                if (year.length === 2) year = "20" + year;
                let month = dateParts[0];
                let day = dateParts[1];
                let hour = parseInt(timeParts[0], 10);
                let minute = timeParts[1];
                if (parts.length > 2) {
                    const meridian = parts[2];
                    if (meridian === "PM" && hour < 12) hour += 12;
                    if (meridian === "AM" && hour === 12) hour = 0;
                }
                return `${year}-${month}-${day}T${hour.toString().padStart(2, '0')}:${minute}:00`;
            }
            function getZohoVal(field) { return (field && field.display_value) ? field.display_value : (field || ""); }
            function getShortName(fullName) {
                if (!fullName) return "Unknown";
                var parts = fullName.trim().split(/\s+/); 
                if (parts.length === 1) return parts[0];
                return parts[0] + " " + parts[parts.length - 1].charAt(0) + ".";
            }
            function countMovers(moversField) {
                if (!moversField) return 0;
                if (Array.isArray(moversField)) return moversField.length; 
                if (typeof moversField === 'string') return moversField.trim() === "" ? 0 : moversField.split(',').length; 
                return 0; 
            }
            function getMoversString(moversField) {
                if (!moversField) return "None assigned";
                if (Array.isArray(moversField)) {
                    return moversField.map(m => (m.display_value ? m.display_value : m)).join(", ");
                }
                return moversField;
            }
            function formatPopupTime(dateObj) {
                if (!dateObj) return "";
                return dateObj.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            }
            function formatPopupDate(dateObj) {
                if (!dateObj) return "";
                return dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
            function updateTodayButton(shouldEnable) {
                var btn = document.querySelector('.fc-resetToday-button');
                if (btn) {
                    btn.style.opacity = shouldEnable ? '1' : '0.5';
                    btn.disabled = !shouldEnable;
                    btn.style.cursor = shouldEnable ? 'pointer' : 'default';
                }
            }

            // --- FETCH DATA -
// --- FETCH DATA ---
            fetch(NETLIFY_ENDPOINT, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            })
            .then(async response => {
                // 1. Check if the request actually worked
                if (!response.ok) {
                    // If server returned 404, 500, or 401, throw an error
                    const text = await response.text();
                    throw new Error(`Server Error: ${response.status} ${response.statusText} \nResponse: ${text.substring(0, 100)}...`);
                }

                // 2. Ensure the response is actually JSON before parsing
                const contentType = response.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    const text = await response.text();
                    // This logs the HTML causing the issue so you can see it in Console
                    console.error("Received HTML instead of JSON:", text); 
                    throw new Error("Received HTML instead of JSON. Check Network Tab.");
                }

                return response.json();
            })
            .then(data => {
                loadingMsg.style.display = 'none';

                // SAFETY CHECK: Ensure data.data exists (Zoho structure)
                const records = data.data || []; 
                
                if (records.length === 0) {
                     console.warn("No events returned from Zoho.");
                }

                var calendarEvents = records.map(function(record) {
                    var startISO = parseZohoDate(record.Agreed_Start_Date_Time);
                    var endISO = parseZohoDate(record.Estimate_End_Date_Time);
                    var safeName = getZohoVal(record.Customer_Name) || "Unknown";
                    var shortName = getShortName(safeName);
                    var originRaw = getZohoVal(record.Origination_Address);
                    var destRaw = getZohoVal(record.Destination_Address); 
                    var servicesRaw = getZohoVal(record.Services_Provided);
                    var requiredCount = parseInt(record.Mover_Count) || 0; 
                    var actualMoversCount = countMovers(record.Movers2); 
                    var moversListString = getMoversString(record.Movers2);

                    var bgColor = '#0C419a'; 
                    var bdColor = '#0C419a';
                    if (servicesRaw.toLowerCase().includes("pending")) {
                        bgColor = '#28a745'; 
                        bdColor = '#28a745';
                    } else if (actualMoversCount < requiredCount) {
                        bgColor = '#fd7e14'; 
                        bdColor = '#fd7e14';
                    }

                    return {
                        title: shortName, start: startISO, end: endISO,
                        backgroundColor: bgColor, borderColor: bdColor, textColor: '#ffffff',
                        extendedProps: { name: safeName, origin: originRaw, destination: destRaw, services: servicesRaw, team: moversListString }
                    };
                });

                var calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    eventDisplay: 'block', 
                    height: 'auto',
                    customButtons: {
                        resetToday: {
                            text: 'Today',
                            click: function() {
                                calendar.today();
                                document.querySelectorAll('.selected-day').forEach(el => el.classList.remove('selected-day'));
                                var todayEl = document.querySelector('.fc-day-today');
                                if (todayEl) todayEl.style.backgroundColor = '';
                                updateTodayButton(false);
                            }
                        }
                    },
                    headerToolbar: { left: 'title', center: '', right: 'prev,next resetToday' },
                    events: calendarEvents,
                    datesSet: function(info) {
                        var today = new Date(); today.setHours(0,0,0,0);
                        if (today >= info.start && today < info.end) updateTodayButton(false);
                        else updateTodayButton(true);
                    },
                    dateClick: function(info) {
                        document.querySelectorAll('.selected-day').forEach(el => el.classList.remove('selected-day'));
                        info.dayEl.classList.add('selected-day');
                        var todayEl = document.querySelector('.fc-day-today');
                        if (todayEl) todayEl.style.backgroundColor = 'transparent';
                        updateTodayButton(true);
                    },
                    eventClick: function(info) {
                        info.jsEvent.preventDefault(); 
                        var props = info.event.extendedProps;
                        var dateStr = formatPopupDate(info.event.start);
                        var startTimeStr = formatPopupTime(info.event.start);
                        var endTimeStr = info.event.end ? formatPopupTime(info.event.end) : "Unknown";
                        var fullTimeHeader = `${dateStr}, ${startTimeStr} - ${endTimeStr}`;
                        
                        var originAddr = (props.origin || "").replace(/missing/gi, "").trim();
                        var destAddr = (props.destination || "").replace(/missing/gi, "").trim();
                        var servicesText = props.services ? String(props.services).trim() : "No service details available.";

                        var isApple = /Mac|iPhone|iPod|iPad/.test(navigator.userAgent);
                        var originLink, destLink;
                        if (isApple) {
                            originLink = "http://maps.apple.com/?daddr=" + encodeURIComponent(originAddr) + "&dirflg=d";
                            destLink = "http://maps.apple.com/?daddr=" + encodeURIComponent(destAddr) + "&dirflg=d";
                        } else {
                            originLink = "https://www.google.com/maps?daddr=" + encodeURIComponent(originAddr) + "&dirflg=t";
                            destLink = "https://www.google.com/maps?daddr=" + encodeURIComponent(destAddr) + "&dirflg=t";
                        }

                        Swal.fire({
                            title: props.name,
                            width: 600,
                            html: `
                                <div style="text-align: left; font-size: 1.1em;">
                                    <div style="margin-bottom: 20px; font-weight: bold; font-size: 1.2em; color: #444; border-bottom: 2px solid #0C419a; padding-bottom: 10px;">üìÖ ${fullTimeHeader}</div>
                                    <div style="margin-bottom: 15px;">
                                        <p style="margin: 0 0 15px 0;"><strong>üìç Pickup:</strong> <a href="${originLink}" target="_blank" class="popup-link">${originAddr}</a></p>
                                        <p style="margin: 0;"><strong>üèÅ Dropoff:</strong> <a href="${destLink}" target="_blank" class="popup-link">${destAddr}</a></p>
                                    </div>
                                    <hr style="border-top: 1px solid #eee; margin: 15px 0;">
                                    <strong>üìã Services Provided:</strong>
                                    <div class="services-box">${servicesText}</div>
                                    <hr style="border-top: 1px solid #eee; margin: 15px 0;">
                                    <strong>üë∑ Team:</strong>
                                    <div style="margin-top: 5px; color: #333; font-weight: 500;">${props.team || "None assigned"}</div>
                                </div>
                            `,
                            showConfirmButton: true,
                            confirmButtonText: 'Close',
                            confirmButtonColor: '#0C419a'
                        });
                    }
                });
                calendar.render();
            })
            .catch(err => {
                // UPDATE THE LOADING MESSAGE ON SCREEN SO YOU SEE THE ERROR
                loadingMsg.innerHTML = `<span style='color:red'><strong>Error:</strong> ${err.message}</span>`;
                console.error("Full Error Details:", err);
            });
                                          
                                          

        }
    </script>
</body>
</html>
