<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metroplex Moving Calendar</title>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 10px; /* Much smaller padding for mobile */
            background-color: #f4f4f4;
        }

        #calendar-container {
            max-width: 1100px;
            margin: 0 auto;
            background: white;
            padding: 10px; /* Reduced padding inside the box */
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        #calendar {
            /* Height will adjust automatically, but we set a min-height */
            min-height: 500px; 
            height: 80vh; /* Takes up 80% of the screen height */
        }

        h2 {
            text-align: center;
            margin-top: 0;
            color: #333;
        }

        #loading {
            text-align: center;
            font-size: 1.2em;
            color: #666;
            margin-bottom: 10px;
        }

        /* --- MOBILE OPTIMIZATIONS --- */
        @media (max-width: 768px) {
            
            /* Stack the header elements nicely */
            .fc-header-toolbar {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .fc-toolbar-chunk {
                display: flex;
                justify-content: center;
                width: 100%; /* Center everything */
            }

            /* Make the Title smaller */
            .fc-toolbar-title {
                font-size: 1.25em !important;
            }

            /* Make buttons slightly smaller and easier to tap */
            .fc-button {
                font-size: 0.9em !important;
                padding: 0.4em 0.65em !important;
            }
            
            /* Hide the "Month/Week/Day" text if needed, or keep it if it fits */
            /* You can create a compact look by un-commenting below: */
            /* .fc-dayGridMonth-button { text-transform: uppercase; letter-spacing: 1px; } */
        }
    </style>
</head>
<body>

    <div id="calendar-container">
        <h2>Job Schedule</h2>
        <div id="loading">Loading calendar data...</div>
        <div id="calendar"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            // 1. Point to your Netlify Function
            const NETLIFY_ENDPOINT = "/.netlify/functions/get-calendar";
            
            const loadingMsg = document.getElementById('loading');
            const calendarEl = document.getElementById('calendar');

            // --- HELPER: Translate "12-23-25 09:00 AM" to "2025-12-23T09:00:00" ---
            function parseZohoDate(dateStr) {
                if (!dateStr) return null;
                // Split "12-23-25 09:00 AM"
                const parts = dateStr.split(' '); 
                if (parts.length < 3) return null;

                const dateParts = parts[0].split('-'); // ["12", "23", "25"]
                const timeParts = parts[1].split(':'); // ["09", "00"]
                const meridian = parts[2];             // "AM"

                // Build ISO Date
                // Note: dateParts[0] is Month, dateParts[1] is Day, dateParts[2] is Year
                let year = "20" + dateParts[2];
                let month = dateParts[0];
                let day = dateParts[1];
                let hour = parseInt(timeParts[0], 10);
                let minute = timeParts[1];

                if (meridian === "PM" && hour < 12) hour += 12;
                if (meridian === "AM" && hour === 12) hour = 0;

                return `${year}-${month}-${day}T${hour.toString().padStart(2, '0')}:${minute}:00`;
            }

            // --- HELPER: Calculate End Time ---
            function getEndTime(startDateIso, endTimeStr) {
                if (!startDateIso || !endTimeStr) return null;
                const dateOnly = startDateIso.split('T')[0];
                const parts = endTimeStr.split(' ');
                if (parts.length < 2) return null;

                const timeParts = parts[0].split(':');
                const meridian = parts[1];
                let hour = parseInt(timeParts[0], 10);
                let minute = timeParts[1];

                if (meridian === "PM" && hour < 12) hour += 12;
                if (meridian === "AM" && hour === 12) hour = 0;

                return `${dateOnly}T${hour.toString().padStart(2, '0')}:${minute}:00`;
            }

            // --- MAIN LOGIC ---
            fetch(NETLIFY_ENDPOINT)
                .then(res => res.json())
                .then(data => {
                    loadingMsg.style.display = 'none';
                    console.log("Zoho Data:", data);

                    // --- THIS IS THE FIX ---
                    var calendarEvents = data.data.map(function(record) {
                        
                        // 1. Run the Translator on the Date
                        var startISO = parseZohoDate(record.Agreed_Start_Date_Time);
                        var endISO = getEndTime(startISO, record.Estimate_End_Date_Time);

                        // 2. Unwrap the Name (Check if it's an object or string)
                        var safeTitle = "Unknown";
                        if (record.Customer_Name && record.Customer_Name.display_value) {
                            safeTitle = record.Customer_Name.display_value;
                        } else if (typeof record.Customer_Name === 'string') {
                            safeTitle = record.Customer_Name;
                        }

                        return {
                            title: safeTitle,  // Now it is a string!
                            start: startISO,   // Now it is ISO format!
                            end: endISO,
                            extendedProps: {
                                address: record.Origination_Address ? record.Origination_Address.display_value : ""
                            }
                        };
                    });

                    console.log("Converted Events:", calendarEvents); // Debug check

                    var calendar = new FullCalendar.Calendar(calendarEl, {
                        initialView: 'dayGridMonth',
                        headerToolbar: {
                            left: 'prev,next today',
                            center: 'title',
                            right: 'dayGridMonth,timeGridWeek,listWeek'
                        },
                        events: calendarEvents,
                        eventClick: function(info) {
                            alert('Job: ' + info.event.title + '\nAddress: ' + info.event.extendedProps.address);
                        }
                    });

                    calendar.render();
                })
                .catch(err => {
                    console.error("Error:", err);
                    loadingMsg.innerText = "Error loading data.";
                });
        });
    </script>
</body>
</html>
