<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metroplex Moving Calendar</title>
    
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* --- BASE STYLES --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 10px; 
            background-color: #f4f4f4;
        }

        #calendar-container {
            max-width: 1100px;
            margin: 0 auto;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        #calendar {
            min-height: 500px; 
            height: 80vh; 
        }

        h2 {
            text-align: center;
            margin-top: 0;
            color: #333;
        }

        #loading {
            text-align: center;
            font-size: 1.2em;
            color: #666;
            margin-bottom: 10px;
        }

        /* --- BRANDING (BLUE #0C419a) --- */
        .fc-button-primary {
            background-color: #0C419a !important;
            border-color: #0C419a !important;
        }
        .fc-button-primary:hover {
            background-color: #082d6e !important;
            border-color: #082d6e !important;
        }
        .fc-button-active {
            background-color: #062252 !important;
            border-color: #062252 !important;
        }

        /* --- POPUP STYLES --- */
        .popup-link {
            color: #3085d6;
            text-decoration: underline;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* Services Box Styles */
        .services-box {
            background-color: #f9f9f9;
            border-left: 4px solid #0C419a;
            padding: 10px;
            margin-top: 5px;
            font-size: 0.9em;
            color: #444;
            white-space: pre-wrap; /* Preserves line breaks */
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
        }

        /* --- RESPONSIVE LOGIC --- */
        .fc-event-title {
            display: inline-block;
            margin-left: 4px;
        }

        @media (max-width: 768px) {
            .fc-header-toolbar {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            .fc-toolbar-chunk {
                display: flex;
                justify-content: center;
                width: 100%; 
            }
            .fc-toolbar-title { font-size: 1.25em !important; }
            .fc-button { font-size: 0.9em !important; padding: 0.4em 0.65em !important; }
        }

        @media (max-width: 600px) and (orientation: portrait) {
            .fc-event-title { display: none; }
            .fc-event-time {
                font-weight: bold;
                font-size: 1.1em;
                text-align: center;
                width: 100%;
                display: block;
            }
        }
    </style>
</head>
<body>

    <div id="calendar-container">
        <h2>Job Schedule</h2>
        <div id="loading">Loading calendar data...</div>
        <div id="calendar"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            const NETLIFY_ENDPOINT = "/.netlify/functions/get-calendar";
            const loadingMsg = document.getElementById('loading');
            const calendarEl = document.getElementById('calendar');

            // --- HELPER: Parse Zoho Date ---
            function parseZohoDate(dateStr) {
                if (!dateStr) return null;
                const parts = dateStr.split(' '); 
                if (parts.length < 3) return null;
                const dateParts = parts[0].split('-'); 
                const timeParts = parts[1].split(':'); 
                const meridian = parts[2];            
                let year = "20" + dateParts[2];
                let month = dateParts[0];
                let day = dateParts[1];
                let hour = parseInt(timeParts[0], 10);
                let minute = timeParts[1];
                if (meridian === "PM" && hour < 12) hour += 12;
                if (meridian === "AM" && hour === 12) hour = 0;
                return `${year}-${month}-${day}T${hour.toString().padStart(2, '0')}:${minute}:00`;
            }

            // --- HELPER: End Time ---
            function getEndTime(startDateIso, endTimeStr) {
                if (!startDateIso || !endTimeStr) return null;
                const dateOnly = startDateIso.split('T')[0];
                const parts = endTimeStr.split(' ');
                if (parts.length < 2) return null;
                const timeParts = parts[0].split(':');
                const meridian = parts[1];
                let hour = parseInt(timeParts[0], 10);
                let minute = timeParts[1];
                if (meridian === "PM" && hour < 12) hour += 12;
                if (meridian === "AM" && hour === 12) hour = 0;
                return `${dateOnly}T${hour.toString().padStart(2, '0')}:${minute}:00`;
            }

            // --- HELPER: Safely Get String ---
            function getZohoVal(field) {
                if (!field) return "";
                if (field.display_value) return field.display_value; 
                if (typeof field === 'string') return field;         
                return "";
            }

            // --- MAIN LOGIC ---
            fetch(NETLIFY_ENDPOINT)
                .then(res => res.json())
                .then(data => {
                    loadingMsg.style.display = 'none';

                    var calendarEvents = data.data.map(function(record) {
                        
                        var startISO = parseZohoDate(record.Agreed_Start_Date_Time);
                        var endISO = getEndTime(startISO, record.Estimate_End_Date_Time);
                        var safeName = getZohoVal(record.Customer_Name) || "Unknown";
                        var originRaw = getZohoVal(record.Origination_Address);
                        var destRaw = getZohoVal(record.Destination_Address); 
                        var servicesRaw = getZohoVal(record.Services_Provided);

                        return {
                            title: safeName, 
                            start: startISO,   
                            end: endISO,
                            backgroundColor: '#0C419a', 
                            borderColor: '#0C419a',
                            textColor: '#ffffff',
                            extendedProps: {
                                name: safeName, 
                                origin: originRaw,
                                destination: destRaw,
                                services: servicesRaw 
                            }
                        };
                    });

                    var calendar = new FullCalendar.Calendar(calendarEl, {
                        initialView: 'dayGridMonth',
                        headerToolbar: {
                            left: 'prev,next today',
                            center: 'title',
                            right: 'dayGridMonth,timeGridWeek,listWeek'
                        },
                        events: calendarEvents,
                        
                        // --- UPDATED CLICK HANDLER ---
                        eventClick: function(info) {
                            info.jsEvent.preventDefault(); 
                            
                            var props = info.event.extendedProps;
                            var customer = props.name;

                            // 1. Clean Addresses: Remove "missing" (case insensitive) and trim whitespace
                            var originAddr = (props.origin || "").replace(/missing/gi, "").trim();
                            var destAddr = (props.destination || "").replace(/missing/gi, "").trim();
                            
                            // 2. Clean Services: Trim leading/trailing whitespace
                            var servicesText = props.services ? String(props.services).trim() : "No service details available.";

                            // 3. Create Links (Destination is assumed to exist now per your request)
                            var originLink = "https://www.google.com/maps/dir/?api=1&destination=" + encodeURIComponent(originAddr);
                            var destLink = "https://www.google.com/maps/dir/?api=1&destination=" + encodeURIComponent(destAddr);

                            // 4. Show Detailed Popup
                            Swal.fire({
                                title: customer,
                                width: 600,
                                html: `
                                    <div style="text-align: left; font-size: 1.1em;">
                                        
                                        <div style="margin-bottom: 15px;">
                                            <p style="margin: 0 0 15px 0;"> 
                                                <strong>üìç Pickup:</strong> 
                                                <a href="${originLink}" target="_blank" class="popup-link">${originAddr}</a>
                                            </p>
                                            <p style="margin: 0;">
                                                <strong>üèÅ Dropoff:</strong> 
                                                <a href="${destLink}" target="_blank" class="popup-link">${destAddr}</a>
                                            </p>
                                        </div>

                                        <hr style="border-top: 1px solid #eee; margin: 15px 0;">

                                        <strong>üìã Services Provided:</strong>
                                        <div class="services-box">
                                            ${servicesText}
                                        </div>

                                    </div>
                                `,
                                showConfirmButton: true,
                                confirmButtonText: 'Close',
                                confirmButtonColor: '#0C419a'
                            });
                        }
                    });

                    calendar.render();
                })
                .catch(err => {
                    console.error("Error:", err);
                    loadingMsg.innerText = "Error loading data.";
                });
        });
    </script>
</body>
</html>
