<!DOCTYPE html>
<html>
<head>
    <title>Zoho Calendar (Authenticated)</title>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        #login-btn { display: none; padding: 10px 20px; background: #0099ff; color: white; border: none; cursor: pointer; }
        #calendar { max-width: 1000px; margin: 20px auto; }
    </style>
</head>
<body>

    <button id="login-btn">Log in to Zoho</button>
    <div id="status">Checking authentication...</div>
    <div id='calendar'></div>

    <script>
        // --- CONFIGURATION ---
        const CLIENT_ID = "1000.FN71FPRIPPILQVE7T4K45RKTS35JXF"; 
        const REDIRECT_URI = "https://metroplex-moving-services.github.io/Intranet/calendar.html"; // Must match Zoho Console exactly
        const SCOPE = "ZohoCreator.report.READ";
        // Find your owner name and app name in your Zoho Creator URL
        // e.g. https://creator.zoho.com/app/owner_name/app_name/...
        const OWNER_NAME = "information152"; 
        const APP_LINK_NAME = "household-goods-moving-services";
        const REPORT_LINK_NAME = "Current_Bookings"; 

        // --- MAIN LOGIC ---
        document.addEventListener('DOMContentLoaded', function() {
            
            // 1. Check if Zoho just redirected us back with a token
            const token = getTokenFromUrl();
            
            if (token) {
                // We have a token! Save it (optional) and Load Calendar
                console.log("Token received:", token);
                loadCalendar(token);
            } else {
                // No token. Show Login Button.
                document.getElementById('status').innerText = "Please log in.";
                const btn = document.getElementById('login-btn');
                btn.style.display = "block";
                btn.onclick = function() {
                    // Redirect to Zoho Login
                    const authUrl = 'https://accounts.zoho.com/oauth/v2/auth?response_type=token&client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}&scope=${SCOPE}&state=123';
                    window.location.href = authUrl;
                };
            }
        });

        // Helper: Extract Access Token from URL Hash (#access_token=...)
        function getTokenFromUrl() {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            return params.get('access_token');
        }

        // --- LOAD DATA & RENDER CALENDAR ---
        function loadCalendar(accessToken) {
            document.getElementById('status').innerText = "Loading data from Zoho...";
            document.getElementById('login-btn').style.display = "none";

            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                events: function(fetchInfo, successCallback, failureCallback) {
                    
                    // The "Private" API URL (Note: different from Public Feed)
                    const apiUrl = 'https://creator.zoho.com/api/v2/${OWNER_NAME}/${APP_LINK_NAME}/report/${REPORT_LINK_NAME}';

                    fetch(apiUrl, {
                        method: 'GET',
                        headers: {
                            'Authorization': 'Zoho-oauthtoken ' + accessToken,
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => {
                        if (!response.ok) throw new Error("API Error: " + response.statusText);
                        return response.json();
                    })
                    .then(data => {
                        // Zoho V2 API returns data inside a "data" array
                        const records = data.data; 
                        
                        const events = records.map(record => ({
                            title: record.Job_Name || "Booking", // Verify field names in console
                            start: record.Date_of_Move,          // Verify field names in console
                        }));
                        successCallback(events);
                        document.getElementById('status').innerText = "";
                    })
                    .catch(error => {
                        console.error("Fetch error:", error);
                        document.getElementById('status').innerText = "Error loading data. Check Console.";
                        failureCallback(error);
                    });
                }
            });
            calendar.render();
            window.scrollTo(0, 0);
        }
    </script>
</body>
</html>
