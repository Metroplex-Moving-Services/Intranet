<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metroplex Moving Calendar</title>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 10px; 
            background-color: #f4f4f4;
        }

        #calendar-container {
            max-width: 1100px;
            margin: 0 auto;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        #calendar {
            min-height: 500px; 
            height: 80vh; 
        }

        h2 {
            text-align: center;
            margin-top: 0;
            color: #333;
        }

        #loading {
            text-align: center;
            font-size: 1.2em;
            color: #666;
            margin-bottom: 10px;
        }

        /* --- CUSTOM BRANDING (BLUE #0C419a) --- */
        
        /* Change the color of the top buttons (Month, Week, Next, Prev) */
        .fc-button-primary {
            background-color: #0C419a !important;
            border-color: #0C419a !important;
        }
        .fc-button-primary:hover {
            background-color: #082d6e !important; /* Slightly darker on hover */
            border-color: #082d6e !important;
        }
        .fc-button-active {
            background-color: #062252 !important;
            border-color: #062252 !important;
        }

        /* --- MOBILE OPTIMIZATIONS --- */
        @media (max-width: 768px) {
            .fc-header-toolbar {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            .fc-toolbar-chunk {
                display: flex;
                justify-content: center;
                width: 100%; 
            }
            .fc-toolbar-title {
                font-size: 1.25em !important;
            }
            .fc-button {
                font-size: 0.9em !important;
                padding: 0.4em 0.65em !important;
            }
        }
    </style>
</head>
<body>

    <div id="calendar-container">
        <h2>Job Schedule</h2>
        <div id="loading">Loading calendar data...</div>
        <div id="calendar"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            const NETLIFY_ENDPOINT = "/.netlify/functions/get-calendar";
            const loadingMsg = document.getElementById('loading');
            const calendarEl = document.getElementById('calendar');

            // --- HELPER: Translate Date ---
            function parseZohoDate(dateStr) {
                if (!dateStr) return null;
                const parts = dateStr.split(' '); 
                if (parts.length < 3) return null;

                const dateParts = parts[0].split('-'); 
                const timeParts = parts[1].split(':'); 
                const meridian = parts[2];            

                let year = "20" + dateParts[2];
                let month = dateParts[0];
                let day = dateParts[1];
                let hour = parseInt(timeParts[0], 10);
                let minute = timeParts[1];

                if (meridian === "PM" && hour < 12) hour += 12;
                if (meridian === "AM" && hour === 12) hour = 0;

                return `${year}-${month}-${day}T${hour.toString().padStart(2, '0')}:${minute}:00`;
            }

            // --- HELPER: End Time ---
            function getEndTime(startDateIso, endTimeStr) {
                if (!startDateIso || !endTimeStr) return null;
                const dateOnly = startDateIso.split('T')[0];
                const parts = endTimeStr.split(' ');
                if (parts.length < 2) return null;

                const timeParts = parts[0].split(':');
                const meridian = parts[1];
                let hour = parseInt(timeParts[0], 10);
                let minute = timeParts[1];

                if (meridian === "PM" && hour < 12) hour += 12;
                if (meridian === "AM" && hour === 12) hour = 0;

                return `${dateOnly}T${hour.toString().padStart(2, '0')}:${minute}:00`;
            }

            // --- MAIN LOGIC ---
            fetch(NETLIFY_ENDPOINT)
                .then(res => res.json())
                .then(data => {
                    loadingMsg.style.display = 'none';

                    var calendarEvents = data.data.map(function(record) {
                        
                        var startISO = parseZohoDate(record.Agreed_Start_Date_Time);
                        var endISO = getEndTime(startISO, record.Estimate_End_Date_Time);

                        // Safe Name Extraction
                        var safeName = "Unknown";
                        if (record.Customer_Name && record.Customer_Name.display_value) {
                            safeName = record.Customer_Name.display_value;
                        } else if (typeof record.Customer_Name === 'string') {
                            safeName = record.Customer_Name;
                        }

                        return {
                            title: "",         // <--- LEFT EMPTY (Only time will show)
                            start: startISO,   
                            end: endISO,
                            
                            // BRANDING COLORS
                            backgroundColor: '#0C419a', 
                            borderColor: '#0C419a',
                            textColor: '#ffffff',

                            // HIDDEN DATA (For Click Popup)
                            extendedProps: {
                                name: safeName, // Store name here to show on click
                                address: record.Origination_Address ? record.Origination_Address.display_value : ""
                            }
                        };
                    });

                    var calendar = new FullCalendar.Calendar(calendarEl, {
                        initialView: 'dayGridMonth',
                        headerToolbar: {
                            left: 'prev,next today',
                            center: 'title',
                            right: 'dayGridMonth,timeGridWeek,listWeek'
                        },
                        events: calendarEvents,
                        
                        // POPUP ON CLICK
                        eventClick: function(info) {
                            alert(
                                'Job Details:\n\n' +
                                'Customer: ' + info.event.extendedProps.name + '\n' +
                                'Address: ' + info.event.extendedProps.address
                            );
                        }
                    });

                    calendar.render();
                })
                .catch(err => {
                    console.error("Error:", err);
                    loadingMsg.innerText = "Error loading data.";
                });
        });
    </script>
</body>
</html>
